---
title: "gnomAD cleaning"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: no
    theme: cerulean
    highlight: pygments
    df_print: paged
editor_options:
  chunk_output_type: console
---

<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   margin-bottom: 25px;
}

table {
    margin-top: 25px;
    <!-- margin-bottom: 100px !important; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 12, data_row.padding = gt::px(1))")
```


<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Manuscript</span>

</div>
<br>

```{r library, include=FALSE}
library(tidyverse)
library(e1071)
library(purrr)
```

```{r load}
path <- fs::path("", "Volumes", "Lab_Gillis", "Christelle")
gnomad <-
  read.delim(paste0(path, "/gnomAD_raw_data/dnmt3a_data.vcf.gz"), 
             header = FALSE, 
             col.names = c("X.CHROM", "POS", "ID", "REF", "ALT", "QUAL", "FILTER", "INFO"))
```

# 1. Data cleaning
As an example I selected all the variant DNMT3A. Here is a example of the raw data.
```{r}
head(gnomad)
```

I first extracted the age bin and sample counts from the `INFO` variable.
```{r}
gnomad_decoded <- gnomad %>% 
  mutate(X.CHROM = str_remove(X.CHROM, "chr")) %>% 
  unite(IDs, c(X.CHROM, POS, REF, ALT), sep = "-") %>% 
  # mutate(IDs = factor(row_number())) %>% 
  
  # ab_hist_alt_bin_freq,Number=A,Type=String,Description="Histogram for AB in heterozygous individuals; 
  # bin edges are: 0.00|0.05|0.10|0.15|0.20|0.25|0.30|0.35|0.40|0.45|0.50|0.55|0.60|0.65|0.70|0.75|0.80|0.85|0.90|0.95|1.00">
  
  # age_hist_het_bin_freq,Number=A,Type=String,Description="Histogram of ages of heterozygous individuals; 
  # bin edges are: 30.0|35.0|40.0|45.0|50.0|55.0|60.0|65.0|70.0|75.0|80.0; 
  # total number of individuals of any genotype bin: 2547|3423|4546|8487|10355|12693|11933|10534|8882|5991|4136|1935">
  mutate(age_hist_het_bin_freq = str_match(INFO, "age_hist_het_bin_freq=(.*?);")[,2]) %>%
  
  # "Count of age values falling below lowest histogram bin edge for heterozygous individuals">
  mutate("<30" = as.numeric(str_match(INFO, "age_hist_het_n_smaller=(.*?);")[,2])) %>%
  # "Count of age values falling above highest histogram bin edge for heterozygous individuals">
  mutate(">80" = as.numeric(str_match(INFO, "age_hist_het_n_larger=(.*?);")[,2])) %>% 
  
  add_row("IDs"="All individuals", "ID"="All individuals",
          "age_hist_het_bin_freq"= "3423|4546|8487|10355|12693|11933|10534|8882|5991|4136",
          "<30" = 2547, ">80" = 1935) %>%
  
  separate(col = age_hist_het_bin_freq,
           into = c("30-35","35-40","40-45","45-50","50-55","55-60","60-65","65-70","70-75","75-80"), 
           sep = "\\|", remove = TRUE, extra = "warn", fill = "right") %>% 
  mutate(across(grep("^[[:digit:]]", colnames(.)), ~ as.numeric(.))) %>% 
  
  # Filter variant found in more than 10 individuals
  mutate(nbr_individuals = rowSums(select(.,`30-35`:`>80`), na.rm = TRUE)) %>% 
  filter(nbr_individuals > 10) %>% 
  select(IDs, everything())
```

```{r, max.print = 30}
head(gnomad_decoded %>% select(IDs, "<30", "30-35","35-40","40-45","45-50","50-55","55-60","60-65","65-70","70-75","75-80", ">80", everything() ))
```

```{r}
gnomad_decoded <- gnomad_decoded %>% 
  pivot_longer(cols = c(grep("[[:digit:]]", colnames(.))), 
               names_to = "age_bin", values_to = "sample_count") %>% 
  mutate(age_bin = factor(age_bin, 
                          levels = c("<30", "30-35","35-40","40-45","45-50","50-55",
                                     "55-60","60-65","65-70","70-75","75-80", ">80"))) %>% 
  mutate(sample_density = sample_count / nbr_individuals)
```
We have data on `r gnomad_decoded %>% distinct(IDs) %>% nrow` DNMT3A variants.  
<br>

The dictionary gives the "reference" distribution =  overall distribution of sample in gnomAD per bins: 2547|3423|4546|8487|10355|12693|11933|10534|8882|5991|4136|1935.  
<br>

Comparing distribution of each variant with the reference:  
We probably need to talk to a statistician, I went to the bio-statistic drop off happening on Tuesdays to ask how to do to compare 2 distributions. Jose said to do a chi-square.  
First, using a chi-square test and kolmogorov smirnov test (I added this one on top - found that it is a good one for distribution), I selected the variants with a distribution significantly different to the reference.  
Then with the skewness test, I kept the variant as long as its distribution is shifted to the right - older age (skewness test > 0).
```{r}
goodness_fit1 <- data.frame(matrix(nrow=1, ncol=0)) 
goodness_fit2 <- data.frame(matrix(nrow=1, ncol=0)) 
skew <- data.frame(matrix(nrow=1, ncol=0)) 

for(i in unique(gnomad_decoded$IDs)) {
  
  All <- gnomad_decoded %>% filter(IDs == "All individuals") %>% select(sample_count)
  
  a <- bind_cols(gnomad_decoded %>% filter(IDs == i) %>% select(sample_count) , All) %>% 
    `colnames<-`(c(i, "All"))
  result <- chisq.test(a[,i], p=a$All, rescale.p=TRUE)$p.value
  goodness_fit1 <- rbind(goodness_fit1, result)
  
  result <- ks.test(a[,i], a$All)$p.value
  goodness_fit2 <- rbind(goodness_fit2, result)
  
  result <- skewness(a[[i]])
  skew <- rbind(skew, result)
  
}
df <- bind_cols(goodness_fit1, goodness_fit2, skew) %>% `colnames<-`(c("chisq", "kolmogorov", "skewness"))
df$IDs <- c(unique(gnomad_decoded$IDs))

# Bind the distribution characteristic values
gnomad_decoded1 <- full_join(gnomad_decoded, df, by = "IDs") %>% 
  # filter the significatant different
  filter((chisq <= 0.05 | kolmogorov <= 0.05) & skewness > 0)
```

After this cleaning, the number of DNMT3A variants is `r gnomad_decoded1 %>% distinct(IDs) %>% nrow`. We need to be more selective...  
But I also think we can reduce their numbers by other means. For example,  

I extracted the VEP annotations data from `INFO`.  
But you can see that in VEP, we have multiple VEP alleles consequence annotation separated by a comma.
```{r}
gnomad_decoded2 <- gnomad_decoded1 %>% 
  mutate(ens_vep = str_match(INFO, ";vep=(.*?)$")[,2])

head(gnomad_decoded2 %>% select(IDs, ens_vep))[1:3,]
```

So I made 1 row for 1 consequence.
```{r}
gnomad_decoded2 <- gnomad_decoded2 %>% 
  separate(col = ens_vep, paste("ens_vep", 1:25, sep=""),
           sep = ",", remove = T, extra = "warn", fill = "right") %>% 
  keep(~!all(is.na(.))) %>% 
  pivot_longer(cols = starts_with("ens_vep"), names_to = NULL, values_to = "ens_vep") %>% 
  drop_na(ens_vep)

head(gnomad_decoded2 %>% select(IDs, ens_vep))
```

For each variant consequence, we now have access to the variables :
`"Allele", "Consequence", "IMPACT", "SYMBOL", "Gene", "Feature_type", "Feature", "BIOTYPE", "EXON", "INTRON", "HGVSc", "HGVSp", "`
  `cDNA_position", "CDS_position", "Protein_position", "Amino_acids", "Codons", "Existing_variation", "ALLELE_NUM", "DISTANCE", "`
  `STRAND", "FLAGS", "VARIANT_CLASS", "MINIMISED", "SYMBOL_SOURCE", "HGNC_ID", "CANONICAL", "TSL", "APPRIS", "CCDS", "ENSP", "SWISSPROT", "`
  `TREMBL", "UNIPARC", "GENE_PHENO", "SIFT", "PolyPhen", "DOMAINS", "HGVS_OFFSET", "GMAF", "AFR_MAF", "AMR_MAF", "EAS_MAF", "EUR_MAF", "`
  `SAS_MAF", "AA_MAF", "EA_MAF", "ExAC_MAF", "ExAC_Adj_MAF", "ExAC_AFR_MAF", "ExAC_AMR_MAF", "ExAC_EAS_MAF", "ExAC_FIN_MAF", "`
  `ExAC_NFE_MAF", "ExAC_OTH_MAF", "ExAC_SAS_MAF", "CLIN_SIG", "SOMATIC", "PHENO", "PUBMED", "MOTIF_NAME", "MOTIF_POS", "`
  `HIGH_INF_POS", "MOTIF_SCORE_CHANGE", "LoF", "LoF_filter", "LoF_flags", "LoF_info"`  
```{r}
# Consequence annotations from Ensembl VEP
# Format: Allele|Consequence|IMPACT|SYMBOL|Gene|Feature_type|Feature|BIOTYPE|EXON|INTRON|HGVSc|HGVSp|
# cDNA_position|CDS_position|Protein_position|Amino_acids|Codons|Existing_variation|ALLELE_NUM|DISTANCE|
# STRAND|FLAGS|VARIANT_CLASS|MINIMISED|SYMBOL_SOURCE|HGNC_ID|CANONICAL|TSL|APPRIS|CCDS|ENSP|SWISSPROT|
# TREMBL|UNIPARC|GENE_PHENO|SIFT|PolyPhen|DOMAINS|HGVS_OFFSET|GMAF|AFR_MAF|AMR_MAF|EAS_MAF|EUR_MAF|
# SAS_MAF|AA_MAF|EA_MAF|ExAC_MAF|ExAC_Adj_MAF|ExAC_AFR_MAF|ExAC_AMR_MAF|ExAC_EAS_MAF|ExAC_FIN_MAF|
# ExAC_NFE_MAF|ExAC_OTH_MAF|ExAC_SAS_MAF|CLIN_SIG|SOMATIC|PHENO|PUBMED|MOTIF_NAME|MOTIF_POS|
# HIGH_INF_POS|MOTIF_SCORE_CHANGE|LoF|LoF_filter|LoF_flags|LoF_info
ens_vep_var_names <- c("Allele", "Consequence", "IMPACT", "SYMBOL", "Gene", "Feature_type", "Feature", "BIOTYPE", "EXON", "INTRON", "HGVSc", "HGVSp", "
  cDNA_position", "CDS_position", "Protein_position", "Amino_acids", "Codons", "Existing_variation", "ALLELE_NUM", "DISTANCE", "
  STRAND", "FLAGS", "VARIANT_CLASS", "MINIMISED", "SYMBOL_SOURCE", "HGNC_ID", "CANONICAL", "TSL", "APPRIS", "CCDS", "ENSP", "SWISSPROT", "
  TREMBL", "UNIPARC", "GENE_PHENO", "SIFT", "PolyPhen", "DOMAINS", "HGVS_OFFSET", "GMAF", "AFR_MAF", "AMR_MAF", "EAS_MAF", "EUR_MAF", "
  SAS_MAF", "AA_MAF", "EA_MAF", "ExAC_MAF", "ExAC_Adj_MAF", "ExAC_AFR_MAF", "ExAC_AMR_MAF", "ExAC_EAS_MAF", "ExAC_FIN_MAF", "
  ExAC_NFE_MAF", "ExAC_OTH_MAF", "ExAC_SAS_MAF", "CLIN_SIG", "SOMATIC", "PHENO", "PUBMED", "MOTIF_NAME", "MOTIF_POS", "
  HIGH_INF_POS", "MOTIF_SCORE_CHANGE", "LoF", "LoF_filter", "LoF_flags", "LoF_info")

gnomad_decoded3 <- gnomad_decoded2 %>% 
  separate(col = ens_vep, into = ens_vep_var_names,
           # paste("ens_vep", 1:100, sep=""),
           sep = "\\|", remove = F, extra = "warn", fill = "right")

head(gnomad_decoded3 %>% select(IDs, "Allele", "Consequence", "IMPACT", "SYMBOL", "Gene", "Feature_type", "Feature", "BIOTYPE", "EXON", "INTRON", "HGVSc", "HGVSp", "
  cDNA_position", "CDS_position", "Protein_position", "Amino_acids", "Codons", "Existing_variation", "ALLELE_NUM", "DISTANCE", "
  STRAND", "FLAGS", "VARIANT_CLASS", "MINIMISED", "SYMBOL_SOURCE", "HGNC_ID", "CANONICAL", "TSL", "APPRIS", "CCDS", "ENSP", "SWISSPROT", "
  TREMBL", "UNIPARC", "GENE_PHENO", "SIFT", "PolyPhen", "DOMAINS", "HGVS_OFFSET", "GMAF", "AFR_MAF", "AMR_MAF", "EAS_MAF", "EUR_MAF", "
  SAS_MAF", "AA_MAF", "EA_MAF", "ExAC_MAF", "ExAC_Adj_MAF", "ExAC_AFR_MAF", "ExAC_AMR_MAF", "ExAC_EAS_MAF", "ExAC_FIN_MAF", "
  ExAC_NFE_MAF", "ExAC_OTH_MAF", "ExAC_SAS_MAF", "CLIN_SIG", "SOMATIC", "PHENO", "PUBMED", "MOTIF_NAME", "MOTIF_POS", "
  HIGH_INF_POS", "MOTIF_SCORE_CHANGE", "LoF", "LoF_filter", "LoF_flags", "LoF_info"))
```

There is multiple type of `Consequence` that we could clean but it is fair to say that I am not the best to make decisions here on which one we want to keep.
```{r}
table(gnomad_decoded3$Consequence)

# table(gnomad_decoded3$SYMBOL)

gnomad_decoded4 <- gnomad_decoded3 %>% 
  filter(!str_detect(Consequence, "3_prime_UTR_variant|5_prime_UTR_variant"), SYMBOL == "DNMT3A")
```
I selected only the varaint not in 3 and 5'. Let me know if I am correct and if I can be more selective.  
But we have the same thing for HGVSc, HGVSp ( I thinkl we only keep the HGVSp )

# 2. Distribution plots
In grey is the distribution of each varaint. In yellow is the reference distribution. I wrote the skewness value at the bottom left.

</div>
</div>

```{r, fig.height= 40, fig.width=12}
data_plot <- gnomad_decoded4 %>% 
  distinct(IDs, age_bin, .keep_all = TRUE) %>% 
  select("IDs", "nbr_individuals", "age_bin", "sample_count", 
         sample_density, 
         skewness, chisq, kolmogorov) %>% 
  mutate(age_bin = factor(age_bin, 
                          levels = c("<30", "30-35","35-40","40-45","45-50","50-55",
                                     "55-60","60-65","65-70","70-75","75-80", ">80")))

ref <- tibble(age_bin = c("<30", "30-35","35-40","40-45","45-50","50-55","55-60",
                          "60-65","65-70","70-75","75-80", ">80"),
              y = c(2547, 3423, 4546, 8487, 10355, 12693, 11933, 10534, 8882, 5991, 4136, 1935)) %>% 
  mutate(age_bin = factor(age_bin, 
                          levels = c("<30", "30-35","35-40","40-45","45-50","50-55",
                                     "55-60","60-65","65-70","70-75","75-80", ">80"))) %>% 
  mutate(sum = sum(y)) %>% 
  mutate(density = y / sum)

ggplot() + 
  geom_col(data = data_plot ,aes(x= age_bin, y= sample_density), 
           position = "identity", 
           fill = "darkblue", 
           alpha = 0.6)+
  theme_minimal()+
  facet_wrap(.~ IDs, ncol = 3, scales = "free_y")+
  geom_col(data =ref, aes(x =age_bin, y = density), position = "identity", fill = "yellow", alpha = 0.5)+ 
  geom_text(
    data    = data_plot,
    mapping = aes(x = -Inf, y = -Inf, label = paste0("skewness=", round(skewness, 2))),
    hjust   = 0,
    vjust   = 0
  )+ 
  geom_text(
    data    = data_plot,
    mapping = aes(x = -Inf, y = -Inf, label = paste0("chisq=", round(chisq, 2))),
    hjust   = 0,
    vjust   = -4.5
  )+ 
  geom_text(
    data    = data_plot,
    mapping = aes(x = -Inf, y = -Inf, label = paste0("KS=", round(kolmogorov, 2))),
    hjust   = 0,
    vjust   = -9
  )
```

You can see that it must be better statistical test...  
Sometimes chi-square or/and KS doesn't remove something which look the same
Note: I could also calculate the kurtosis to look at how "pointy" the distribution is.


























